---
title: "R Notebook"
output: html_notebook
---

```{r}

library(Seurat)
library(reticulate)
library(scrubletR)
library(ggplot2)
library(SeuratDisk)

obj.mouse <- LoadH5Seurat("E:/Mouse_M1/seurat/mouse_m1_gabaergic_sst.h5seurat")
obj.mouse[["dataset"]] <- "Mouse_M1"
obj.opossum <- LoadH5Seurat("E:/Opossum_M1/seurat/opossum_m1_gabaergic_sst.h5seurat")
obj.opossum[["dataset"]] <- "Opossum_M1"

obj.mouse <- obj.mouse[, sample(colnames(obj.mouse), size = ncol(obj.opossum), replace = FALSE)]

```


```{r}

common.features <- intersect(rownames(obj.mouse), rownames(obj.opossum))
obj.combined <- merge(obj.mouse[common.features,], y = obj.opossum[common.features,])

```


```{r}

obj.list <- SplitObject(obj.combined, split.by = "dataset")

obj.list <- lapply(X = obj.list, FUN = function(x) {
    x <- NormalizeData(x)
    x <- FindVariableFeatures(x, selection.method = "vst", nfeatures = 500)
})

features <- SelectIntegrationFeatures(object.list = obj.list, nfeatures = 500)

```


```{r}

integ.anchors <- FindIntegrationAnchors(object.list = obj.list, anchor.features = features)
integ.combined <- IntegrateData(anchorset = integ.anchors)

```


```{r}

DefaultAssay(integ.combined) <- "integrated"

integ.combined <- ScaleData(integ.combined, verbose = FALSE)
integ.combined <- RunPCA(integ.combined, verbose = FALSE)
integ.combined <- RunUMAP(integ.combined, dims = 1:30)

```

```{r}

DimPlot(integ.combined, reduction = "umap", group.by = "dataset", raster = FALSE) + xlim(-12, 12) + ylim(-12, 12) + coord_equal()
DimPlot(integ.combined, reduction = "umap", split.by = "dataset", group.by = "cluster_label", raster = FALSE) + xlim(-12, 12) + ylim(-12, 12) + coord_equal()
DimPlot(integ.combined, reduction = "umap", split.by = "dataset", group.by = "RNA_snn_res.3.5", raster = FALSE) + xlim(-12, 12) + ylim(-12, 12) + coord_equal()

```

```{r}

FeaturePlot(integ.combined, split.by = "dataset", features = c("C1ql3"))
FeaturePlot(integ.combined, split.by = "dataset", features = c("C1ql3"))

```

