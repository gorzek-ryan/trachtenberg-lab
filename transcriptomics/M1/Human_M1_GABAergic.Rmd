---
title: "Human M1 GABAergic"
output: html_notebook
---

```{r}

library(Seurat)
library(reticulate)
library(arrow)
library(ggplot2)
library(dplyr)
library(SeuratDisk)
obj.human.gabaergic <- LoadH5Seurat("E:/Human_M1/seurat/human_m1_gabaergic.h5Seurat")

```

```{r}

obj.human.gabaergic <- SplitObject(obj.human.gabaergic, split.by = "donor_id")

for (sample in names(obj.human.gabaergic)) {
    obj.human.gabaergic[[sample]] <- SCTransform(obj.human.gabaergic[[sample]], vst.flavor = "v2", verbose = FALSE) %>%
    RunPCA(npcs = 30, verbose = FALSE)
}

```


```{r}

features <- SelectIntegrationFeatures(object.list = obj.human.gabaergic, nfeatures = 2000)
obj.human.gabaergic <- PrepSCTIntegration(object.list = obj.human.gabaergic, anchor.features = features)
obj.human.anchors <- FindIntegrationAnchors(object.list = obj.human.gabaergic, normalization.method = "SCT", anchor.features = features)
obj.human.sct <- IntegrateData(anchorset = obj.human.anchors, normalization.method = "SCT")

```


```{r}

obj.human.sct <- RunPCA(obj.human.sct, verbose = FALSE)
obj.human.sct <- RunUMAP(obj.human.sct, dims = 1:30, method = "umap-learn", reduction = "pca")
obj.human.sct <- FindNeighbors(obj.human.sct, reduction = "pca", dims = 1:30)
obj.human.sct <- FindClusters(obj.human.sct, resolution = 1, algorithm = 4, method = "igraph")

```


```{r}

DimPlot(obj.human.sct, reduction = "umap", label = TRUE, raster = FALSE) + NoLegend() + xlim(-18, 18) + ylim(-18, 18) + coord_equal()
DimPlot(obj.human.sct, reduction = "umap", group.by = "donor_id", raster = FALSE) + xlim(-18, 18) + ylim(-18, 18) + coord_equal()
#DimPlot(obj.human.sct, reduction = "umap", group.by = "predicted_doublets", raster = FALSE) + xlim(-18, 18) + ylim(-18, 18) + coord_equal()
DimPlot(obj.human.sct, reduction = "umap", group.by = "subclass_label", raster = FALSE) + xlim(-18, 18) + ylim(-18, 18) + coord_equal()

```


```{r}
Idents(obj.human.sct) = "subclass_label"
cells.sst <- WhichCells(obj.human.sct, idents = c("Sst Chodl"))
obj.human.sct$subclass_label[cells.sst] <- "Sst"
```


```{r}

DimPlot(obj.human.gabaergic, reduction = "umap", label = TRUE, raster = FALSE) + NoLegend() + xlim(-15, 15) + ylim(-15, 15) + coord_equal()
# DimPlot(obj.human.gabaergic, reduction = "umap", group.by = "cluster_label", raster = FALSE) + xlim(-15, 12) + ylim(-15, 15) + coord_equal()

```

```{r}

pvalb.palette <- "#468fba"
sst.palette <- "#ba1851"
vip.palette <- "#a85d96"
lamp5.palette <- "#a2bc8c"
sncg.palette <- "#f6cb7c"

# levels(obj.human.gabaergic) <- c("Pvalb", "Sst", "Vip", "Lamp5", "Sncg")

fig <- DimPlot(obj.human.gabaergic, reduction = "umap", raster = FALSE, label = TRUE, cols = c(pvalb.palette, sst.palette, vip.palette, lamp5.palette, sncg.palette)) + NoLegend() + xlim(-13, 17) + ylim(-17, 13) + coord_equal()

ggsave("G:/Shared drives/Opossum transcriptomics/figures/Species_GABAergic_UMAP_Plots/Human_UMAP_GABAergic_subclass.png", fig, width=4, height=4, dpi=500)

```


```{r}

Idents(obj.human.sct) <- "subclass_label"
SaveH5Seurat(obj.human.sct, "E:/Human_M1/seurat/human_m1_gabaergic.h5seurat", overwrite = TRUE, verbose = TRUE)

```

